# 試験管ソートゲーム 引き継ぎ

## 1. プロジェクトの目的
色分けされた試験管の中身を整理するブラウザパズルゲーム。
最終的にPoki/UnityRoomに公開予定。
オンラインランキング機能で競争性を持たせる。

## 2. ディレクトリマップと役割
```
src/
  components/     UI層（Game, Ranking, DailyBonusTube等）
  services/       API通信（rankingService.js）
  utils/          ユーティリティ（sanitize.js: XSS対策）
  config/         Firebase設定
  styles/         CSS
  domain/         ゲームロジック
  hooks/          React hooks
netlify/
  functions/      サーバーレスAPI（get-rankings, submit-score）
```

## 3. 技術選定と制約

### データベース: Firebase Realtime Database
- 理由: 無料枠が広く、Poki/UnityRoomでの実績あり
- Netlify Functionsと相性が良い（CORS問題回避）

### ランキングのルール
- RTAモード: クリアタイムのみで順位
- 通常モード: 最大到達ステージで順位
- Top10まで表示
- 記録から30日経過で自動削除
  - 理由: ユーザーが「31日に取った人が可哀想」と要望

### プレイヤー名の扱い
- デフォルト: "名無し"
- 最大20文字（絵文字対応）
- XSS対策実装済み（HTMLタグ除去、エスケープ処理）
  - 理由: ユーザーが改行攻撃（`<br>`）等の対策を要求

### セキュリティ
- 同一IPから1分間に5回まで送信制限
  - 理由: Netlify無料枠保護
- チート対策なし（後回し）

### 送信タイミング
- ローカルベスト更新 AND Top10入りの可能性がある時のみ
- 理由: サーバー負荷削減

## 4. 現状と次の一手

### 完了済み
- ✅ Firebase Realtime Database設定完了
- ✅ Netlify Functions実装（get-rankings, submit-score）
- ✅ XSS対策・30日自動削除・IP制限実装
- ✅ フロントエンドとFirebase連携
- ✅ GitHubにプッシュ済み
- ✅ .gitignoreでAPIキー保護

### 次のタスク
1. **Netlifyで環境変数を設定（進行中）**
   - ✅ 1個目: `VITE_FIREBASE_API_KEY` 設定完了
   - ⏳ 残り10個: インポート画面でテキストエリアにコピペ
   - テキストは `/Users/kitazawaharesora/test-tube-sort-game/netlify-env-vars.txt` に保存済み
   - コピペ後「Import variables」をクリック

2. **動作確認**
   - ランキング表示が動くか
   - スコア登録が動くか
   - 30日自動削除が動くか

3. **テストデータ投入**
   - 複数モードでランキング登録
   - Top10の表示確認

### 保留中の課題
- なし（ランキング機能の枠組みは完成）

### メモ
- サービスアカウントキーのJSONファイルは絶対にGitにコミットしない
- Netlifyの環境変数に`FIREBASE_PRIVATE_KEY`を設定する際は、改行を`\n`に置き換えて1行にする
-今回のプロジェクトでは途中から引き継ぎを作り出したので情報の欠落が多いことに注意
