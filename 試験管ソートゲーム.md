## 1. プロジェクトの目的
色分けされた試験管の中身を整理するブラウザパズルゲーム。
最終的にPoki/UnityRoomに公開予定。
オンラインランキング機能で競争性を持たせる。

## 2. ディレクトリマップと役割
```
src/
  components/     UI層（Game, Ranking, DailyBonusTube等）
  services/       API通信（rankingService.js）
  utils/          ユーティリティ（sanitize.js: XSS対策）
  config/         Firebase設定
  styles/         CSS
  domain/         ゲームロジック
  hooks/          React hooks
netlify/
  functions/      サーバーレスAPI（get-rankings, submit-score）
    utils/        共通ユーティリティ（firebase-init.js: Firebase初期化ロジック）

【補足】バグ事例集
/Users/kitazawaharesora/bugs/時間泥棒バグ集/
  プロジェクト横断で使える難航バグ事例集（タイトルは抽象的、中身は具体的）
```

## 3. 技術選定と制約

### データベース: Firebase Realtime Database
- 理由: 無料枠が広く、Poki/UnityRoomでの実績あり
- Netlify Functionsと相性が良い（CORS問題回避）
- **リージョン**: asia-southeast1（シンガポール）
- **Database URL**: `https://tube-sort-game-default-rtdb.asia-southeast1.firebasedatabase.app`

### 環境変数（Netlify）
- `FIREBASE_PROJECT_ID`
- `FIREBASE_CLIENT_EMAIL`
- `FIREBASE_PRIVATE_KEY_BASE64`: Base64エンコードされた秘密鍵（改行問題の回避）
- `FIREBASE_DATABASE_URL`: リージョン付きURL
- 理由: ブラウザMCPでのCmd+Vペーストでは改行が失われるため、Base64エンコード方式を採用

### firebase-init.jsの設計
- `FIREBASE_PRIVATE_KEY_BASE64`を優先的に使用（Base64デコード）
- フォールバック: `FIREBASE_PRIVATE_KEY`（従来の方式、後方互換性）
- 疎結合: 環境変数の形式に柔軟に対応
- 拡張性: 将来的な変更が一箇所で済む設計

### ランキングのルール
- RTAモード: クリアタイムのみで順位
- 通常モード: 最大到達ステージで順位
- Top10まで表示
- 記録から30日経過で自動削除

### プレイヤー名の扱い
- デフォルト: "名無し"
- 最大20文字（絵文字対応）
- XSS対策実装済み（HTMLタグ除去、エスケープ処理）

### セキュリティ
- 同一IPから1分間に5回まで送信制限
- チート対策なし（後回し）

### 重要な制約
- **ゲーム画面の確認はユーザーが実施**（Claudeは禁止）
- mcpログやコンテキストでの確認のみ可能

## 4. 現状と次の一手

### 完了済み ✅
- ✅ Firebase Realtime Database設定完了
- ✅ Netlify Functions実装（get-rankings, submit-score）
- ✅ XSS対策・30日自動削除・IP制限実装
- ✅ フロントエンドとFirebase連携
- ✅ GitHubにプッシュ済み
- ✅ DailyBonusTubeをランキング画面で非表示化
- ✅ Firebase秘密鍵ファイル再生成
- ✅ **環境変数FIREBASE_PRIVATE_KEY_BASE64を設定（改行問題解決）**
- ✅ **firebase-init.jsをBase64対応に修正**
- ✅ **FIREBASE_DATABASE_URLをリージョン付きURLに修正**
- ✅ **デプロイ成功・動作確認完了**
- ✅ **時間泥棒バグ集フォルダ作成・初回バグ記録完了**

### 次の作業
**現時点で残っているタスクはありません！** 🎉

### ユーザーが確認すべき項目
1. ゲーム画面でランキング機能が正常に動作するか確認
2. スコア送信が正常に動作するか確認
3. ランキング表示が正しく更新されるか確認
