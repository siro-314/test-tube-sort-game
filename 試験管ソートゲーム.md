# 試験管ソートゲーム 引き継ぎ

## 1. プロジェクトの目的
色分けされた試験管の中身を整理するブラウザパズルゲーム。
最終的にPoki/UnityRoomに公開予定。
オンラインランキング機能で競争性を持たせる。

## 2. ディレクトリマップと役割
```
src/
  components/     UI層（Game, Ranking, DailyBonusTube等）
  services/       API通信（rankingService.js）
  utils/          ユーティリティ（sanitize.js: XSS対策）
  config/         Firebase設定
  styles/         CSS
  domain/         ゲームロジック
  hooks/          React hooks
netlify/
  functions/      サーバーレスAPI（get-rankings, submit-score）
```

## 3. 技術選定と制約

### データベース: Firebase Realtime Database
- 理由: 無料枠が広く、Poki/UnityRoomでの実績あり
- Netlify Functionsと相性が良い（CORS問題回避）

### ランキングのルール
- RTAモード: クリアタイムのみで順位
- 通常モード: 最大到達ステージで順位
- Top10まで表示
- 記録から30日経過で自動削除

### プレイヤー名の扱い
- デフォルト: "名無し"
- 最大20文字（絵文字対応）
- XSS対策実装済み（HTMLタグ除去、エスケープ処理）

### セキュリティ
- 同一IPから1分間に5回まで送信制限
- チート対策なし（後回し）

### 重要な制約
- **ゲーム画面の確認はユーザーが実施**（Claudeは禁止）
- mcpログやコンソールでの確認のみ可能

## 4. 現状と次の一手

### 完了済み
- ✅ Firebase Realtime Database設定完了
- ✅ Netlify Functions実装（get-rankings, submit-score）
- ✅ XSS対策・30日自動削除・IP制限実装
- ✅ フロントエンドとFirebase連携
- ✅ GitHubにプッシュ済み（最新: ebcb9cf）
- ✅ Netlify環境変数設定（11個全て）
- ✅ DailyBonusTubeをランキング画面で非表示化
- ✅ Netlify UIで環境変数を手動更新（FIREBASE_PRIVATE_KEY）
- ✅ 新しいデプロイ完了（11:14 AM）

### 現在の問題
**エラー:** `Failed to parse private key: Error: Invalid PEM formatted message.`

**原因:**
- Netlify UIで改行を含むテキストをペーストしたが、正しく保存されなかった
- 表示上は`"-----BEGIN PRIVATE KEY-----"`のみ
- 実際の改行が保持されていない

**試したこと:**
1. ❌ `split('\\n').join('\n')`による変換（Functionに実装済み）
2. ❌ Netlify UIで直接ペースト（改行が保持されない）

### 次のアプローチ
**Base64エンコード方式:**
1. 秘密鍵をbase64エンコードして環境変数に保存
2. Function側でbase64デコード
3. その後`\n`を改行に変換

**手順:**
1. base64エンコード済みの値（既に取得済み）:
```
LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdlFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLY3dnZ1NqQWdFQUFvSUJBUUNpeVMzVk90NDNEdUV4XG5pNXlCVUQrR3daK0dGZnpsanR1a1o5VHRTV1dreW5aS3RWdWxvL1lxL1hyWnZSRDRSZXhjK3RkSTdMbndyMEdTXG5pclA4L1kzUFBpRFpBR2g4QWdwZ0c2S2Fpdi9PSFYwZ1pYcWpORDVENXlYalNTNEhTa0dFb2toSnpqR0lkSldjXG5vNGY4TDFmYlNsZzg3U2VHYnZhZm9ETHhjYVE3Rk9kN1JmOTBvdVJuMlI5OWhGeEJWVDlNTkRyZCtxSlVBRTVGXG52YmNmOVRxL0pDanRvNWQ5SHpDOEN1eWFmOHA0OW5WdC8wcHVsNnZlYUlhV3ZaQk1jeUVhVEg1ZFVXZGM5T0dRXG5vbFIrZnNCR21kaVgyMU0rZ2ZrTm9vQ25CUENGSnFQTHozNXJlU0h1Ym9GT2RiemVPUFJFdDRUc0pLK1ZHMTdSXG4vYWpRN3ozQWdNQkFBRUNnZ0VBTDhoSHVOQlh5K2VGT0lyWGZLbTJpL0tueGE4TWxjRnlQWGJ3N0ZuZ0NSZ1lcbjB1TWJMS3JOSmw5VFFUaWJFNVZLeFJ3b04xS3RYYlhEMUtUOElpVzNDMzhjR3paZ2RRNFFSNWUxQ2hJRTlsWnVcbk1JVTVFMURSZWhNT2J3SGJEZTdBL3BLNEQxb0Q5aDdxajVqODRJeHhDSUJ4R0Nrd3NlZytZaXFlNlhwSEQ4UWhcbndHWnZJbExPMTBKeDQzTkdNcG1nelVlTHYvTlM3NWxjeGpvODlGci9YYjI3YWNTaVlsOHNMaUhsTlhRMHdma2Ncbk5JdjRiNW1SMndwRU9SRlBiUFBheStBbVpjemhDd3RqRzhWL2V3emoyTHBDVWlBUU5vbUdjL1BZQm9hY2NqN2JcbkYxV0xtWGtOUHZQN1NOZE83QS8xbVMzb284UFRSODczcDk4Rm9MbFFXUUtCZ1FEZkxTdUFCQzlLZEIxSkk4OStcbjFKUnd5RjBxOU9xek1NOG1mRmlDWm92QUNZVEwxVkN2bVhwbTBmbHRpNmluWDY5ZkN5Uk1Rb3BGTU1tM1pmWEFcbmI5QkROYStPNzIwVGZSMVl1bnAwL1htL3VOQ1RCclhtVjlyc0N3a0FSOVpPRTFPbmNrSWlscHFpRjlOamIvQWxcbjBFbUNTSTBDNEMzdDBkelZ6VDl0bWhDeFF3S0JnUUM2dWoxRGdUR0RZWi8wcXE1K3lEN3VmcDVzbXVzanozRllcbnc3TVJHdURRSmZiM1V4QTREZjZpaUdiM2tWZm1SRlJ1eEY4eEVQOXNCUkJFWm5UbUJBS0tBVVBqei9QY0d6QkJcblBUUFI3RDk2UHBQVDBqQm1WUkhsL0ZQbkRJdlhpMUZURDJnVnN5T0hzLzFXYW52MVhIQmY2VTFqelgzTmZkck5cbkhWd2pHamlBUFFLQmdRRE00RWVWdnNHM0pMOFp2S0VvT25pR3pMa1N6VUdEL0dPK1hkcFc0MUtabVdOcVI4cEpcbldhalBLU1ZFVmpnZVpxMjBuNkxUeXlYcC9LN0JDUDNBaWlUeS9oN0xKYXJKZ0VybmdGRVlndlU0ZHE0cXVyZFRcbjNRVWhPY1FxbU1mNFpxK2VBVHNMUzV4cS8xcFVaNWRhNzBuOEt5UWdKcktqSnN3SERlT1RkeUtweHdLQmdFOTVcbnNWV29DV0Q0RGxMZXlzSmZqSm1KL3ZnT3dBSlA2dGh6QXlaR29HVTNvM1FGUUtQN0lPUWcxbUtNMURMSDVuLzJcbnlPVmpiTE9YUENOQTBJU09ORjUweDJhUlBpUHkxb2tOK1o1aHhXck1jN0wyaFc4b3lpTnZVRzdJNGtSdG9jR09cbmp5aWRSSVFmMGJZVVFJcGdPOXcydXArOStNdWJ3Nk1GMmc5K3U0bXBBb0dBUU5Hc2toUDUxN1NIYWUrZUVERXZcbjlvbkZPaFlFcHZoNnpWbnVIMTRTVWVCMnBkQmw4emdMUHNqQ0xGQ1lmS0JCOWQ3d3gyY2VueVJJczd4Y1ljTFZcblZsMmw1YVlJc1c0dmpMOEt4d3g2SXhrY1l2bkVlQXZnY29oUmdXeE16anJHNDA3OGJVYWk0c3M5VEhhUHRRWElcblJiSWhCZFY2M0pKanhSZ3Y0T0l1cDNBPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuCg==
```

2. 両方のFunctionsコードを更新（base64デコード処理を追加）
3. GitHubにプッシュ
4. Netlify UIでFIREBASE_PRIVATE_KEYを上記のbase64値に変更
5. 再デプロイ
6. 動作確認

### メモ
- サービスアカウントキーのJSONファイルは絶対にGitにコミットしない
- `netlify-env-vars.txt`も.gitignoreで保護済み
- Netlify UIでは複数行テキストが正しく保存されない問題あり
- base64エンコード方式を採用する必要あり
