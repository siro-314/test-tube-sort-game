# 試験管ソートゲーム 引き継ぎ

## 1. プロジェクトの目的
色分けされた試験管の中身を整理するブラウザパズルゲーム。
最終的にPoki/UnityRoomに公開予定。
オンラインランキング機能で競争性を持たせる。

## 2. ディレクトリマップと役割
```
src/
  components/     UI層（Game, Ranking, DailyBonusTube等）
  services/       API通信（rankingService.js）
  utils/          ユーティリティ（sanitize.js: XSS対策）
  config/         Firebase設定
  styles/         CSS
  domain/         ゲームロジック
  hooks/          React hooks
netlify/
  functions/      サーバーレスAPI（get-rankings, submit-score）
```

## 3. 技術選定と制約

### データベース: Firebase Realtime Database
- 理由: 無料枠が広く、Poki/UnityRoomでの実績あり
- Netlify Functionsと相性が良い（CORS問題回避）

### ランキングのルール
- RTAモード: クリアタイムのみで順位
- 通常モード: 最大到達ステージで順位
- Top10まで表示
- 記録から30日経過で自動削除
  - 理由: ユーザーが「31日に取った人が可哀想」と要望

### プレイヤー名の扱い
- デフォルト: "名無し"
- 最大20文字（絵文字対応）
- XSS対策実装済み（HTMLタグ除去、エスケープ処理）
  - 理由: ユーザーが改行攻撃（`<br>`）等の対策を要求

### セキュリティ
- 同一IPから1分間に5回まで送信制限
  - 理由: Netlify無料枠保護
- チート対策なし（後回し）

### 送信タイミング
- ローカルベスト更新 AND Top10入りの可能性がある時のみ
- 理由: サーバー負荷削減

## 4. 現状と次の一手

### 完了済み
- ✅ Firebase Realtime Database設定完了
- ✅ Netlify Functions実装（get-rankings, submit-score）
- ✅ XSS対策・30日自動削除・IP制限実装
- ✅ フロントエンドとFirebase連携
- ✅ GitHubにプッシュ済み
- ✅ .gitignoreでAPIキー保護
- ✅ Netlifyで環境変数設定（11個全て）
- ✅ 手動デプロイ実行（環境変数反映のため）
- ✅ DailyBonusTubeをランキング画面で非表示化
- ✅ FIREBASE_PRIVATE_KEY二重エスケープ問題修正
  - 問題: Netlify環境変数で`\n`が`\\n`になり、さらに`\\\\n`と二重エスケープされる
  - 解決: 二段階の置換処理を実装（`\\\\n` → `\\n` → 改行）

### 次のタスク
1. **デプロイ完了待機**
   - 最新コミット: `6240e2e` "Fix FIREBASE_PRIVATE_KEY double-escape issue, hide DailyBonusTube on ranking screen"
   - 自動デプロイ進行中（GitHubプッシュ済み）

2. **動作確認（ユーザーが実施）**
   - ランキング表示が動くか
   - スコア登録が動くか
   - DailyBonusTubeがランキング画面で非表示になっているか

3. **テストデータ投入**
   - 複数モードでランキング登録
   - Top10の表示確認

### 保留中の課題
- なし（エラー修正完了、デプロイ待ち）

### メモ
- サービスアカウントキーのJSONファイルは絶対にGitにコミットしない
- `netlify-env-vars.txt`も.gitignoreで保護済み
- FIREBASE_PRIVATE_KEYは二重エスケープ対策済み
